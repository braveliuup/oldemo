function e(e){e.loadXYZLayerTiandDiTu=function(){return new ol.layer.Tile({source:new ol.source.XYZ({url:"http://t2.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}"}),visible:!1})},e.loadXYZLayerTiandDiTu_label=function(){return new ol.layer.Tile({source:new ol.source.XYZ({url:"http://t2.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}"}),visible:!1})},e.loadXYZLayerCustom=function(){var e=new ol.source.XYZ({wrapX:!1,projection:ol.proj.get("EPSG:3857"),tileUrlFunction:function(e,t,o){if(!e)return"";var r="L"+e[0],i=e[1]-Math.pow(2,e[0]-1),a=-e[2]-1,l="C"+parseInt(i*Math.pow(2,19-e[0])/512)+"R"+parseInt(a*Math.pow(2,19-e[0])/512);return n.map.pic+l+"/1/"+r+"/"+i+","+a+".png"}});return new ol.layer.Tile({source:e,zIndex:0})},e.loadNewEduShiLayer=function(){var t=new ol.source.TileImage({projection:d,tileGrid:f,tileUrlFunction:function(t,o,r){var i=e.zeroPad(t[0],2,10),a=e.zeroPad(t[1],8,16),l=e.zeroPad(-t[2]-1,8,16);return n.map.pic+"L"+i+"/R"+l+"/C"+a+".png"}});return new ol.layer.Tile({source:t})},e.zeroPad=function(e,t,o){for(var r=e.toString(o||10);r.length<t;)r="0"+r;return r},e.rat_ori=function(e){return ycenter=406e4,[(e[0]-1212e4)*Math.sqrt(2)*.5-(e[1]-ycenter)*Math.sqrt(2)/.65*.5+1212e4,(e[0]-1212e4)*Math.sqrt(2)*.5+(e[1]-ycenter)*Math.sqrt(2)/.65*.5+ycenter]},e.ori_rat=function(e){return ycenter=406e4,[(e[1]-ycenter+(e[0]-1212e4))/Math.sqrt(2)+1212e4,.65*(e[1]-ycenter-(e[0]-1212e4))/Math.sqrt(2)+ycenter]},e.init=function(){var t,o=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,33,33,0.0)"})}),r=new ol.control.MousePosition,i=new ol.source.Vector({wrapX:!1}),m=new ol.layer.Vector({source:i,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})});u=m,a=e.loadXYZLayerTiandDiTu(),l=e.loadXYZLayerTiandDiTu_label(),s=e.loadNewEduShiLayer();var f=new ol.source.Vector({format:new ol.format.GeoJSON({defaultDataProjection:"EPSG:3857",featureProjection:"EPSG:4326"}),url:function(e){return e=ol.proj.transformExtent(e,"EPSG:4326","EPSG:3857"),n.map.geoserver+"/wfs?service=WFS&version=1.1.0&request=GetFeature&typename="+n.map.typename+"&outputFormat=application/json&srsname=EPSG:3857&bbox="+e.join(",")+",EPSG:3857"},strategy:ol.loadingstrategy.bbox});return c=new ol.layer.Vector({source:f,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0, 0, 255, 0.0)",width:2}),fill:new ol.style.Fill({color:"rgba(144,144,0, 0.0)"})})}),(map=new ol.Map({interactions:ol.interaction.defaults({doubleClickZoom:!1,altShiftDragRotate:!1,pinchRotate:!1}),target:document.getElementById("map"),layers:[s,a,l,m,c,v],view:new ol.View({center:[108.93867,34.250293],resolutions:p,projection:d,zoom:16,maxZoom:19}),controls:[r]})).on("pointermove",function(e){if(map.measureActivated)t&&t.setStyle(o);else{var r=map.getEventPixel(e.originalEvent),n=map.hasFeatureAtPixel(r);map.getTarget().style.cursor=n?"pointer":"";var i=map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});t&&t.setStyle(o),!i||"Polygon"!=i.getGeometry().getType()&&"MultiPolygon"!=i.getGeometry().getType()||(t=i,i.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,33,33,0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2})})))}}),map}}function t(e){var t={};for(var o in e)"object"!=typeof e[o]&&(t[o]=e[o]);return t}var o=new Array;$.cachedScript=function(e,t){for(var r in o)if(o[r]==e)return{done:function(e){"function"==typeof e&&e()}};return t=$.extend(t||{},{dataType:"script",cache:!0,url:e}),o.push(e),$.ajax(t)};var r={info:function(e){console.log(e)},debug:function(e){console.log(e)}},n={map:{pic:"http://118.178.125.174:9999/data/hmp0-19/",geoserver:"http://118.178.125.174:9999/geoserver/",typename:"ww:xianceshi",featurePrefix:"ww",featureTypes:["xianceshi-web"],center:[108.90536,34.28138],zoom:14,maxZoom:24,minZoom:13}},i={},a,l,s,c,u,d=ol.proj.get("EPSG:4326"),m=[-400,400],p=[.7031250000029744,.3515625000014872,.1757812499888463,.08789062499442316,.04394531250910888,.021972656242657134,.010986328121328567,.00549316407256159,.0027465820243834896,.0013732910240890498,.0006866455120445249,.0003433227441249574,.00017166138395978374,8583068008258684e-20,4291534004129342e-20,2145767002064671e-20,9658089455004757e-21,5364423453814192e-21,2682199829602067e-21,13411118121060625e-22],f=new ol.tilegrid.TileGrid({tileSize:256,origin:m,resolutions:p}),y=new ol.source.Vector,v=new ol.layer.Vector({source:y,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, .5)"})})});e(i);var map=i.init(),h={overlay:null,content:null,initialized:!1,popup:null,init:function(){var e=document.getElementById("feature-popup");this.content=document.getElementById("feature-popup-content");var t=document.getElementById("feature-popup-closer"),o=new ol.Overlay({element:e,autoPan:!0,autoPanAnimation:{duration:250}});t.onclick=function(){return o.setPosition(void 0),t.blur(),!1},map.addOverlay(o),this.overlay=o,this.popup=e,this.initialized=!0},show:function(e,t){this.initialized||this.init(),this.content.innerHTML=t,this.overlay.setPosition(e),this.popup.style.display="block"}},g={overlay:null,content:null,initialized:!1,delMark:null,delLbl:null,markSource:null,closer:null,popup:null,markIdIdx:0,markIdName:"marklayer",init:function(){var e=document.getElementById("mark-popup");this.content=document.getElementById("mark-popup-content");var t=document.getElementById("mark-popup-closer"),o=new ol.Overlay({element:e,autoPan:!0,autoPanAnimation:{duration:250}});t.onclick=function(){return o.setPosition(void 0),t.blur(),!1},map.addOverlay(o);var r=new ol.source.Vector,n=new ol.layer.Vector({style:function(e){return e.get("style")},source:r});map.getLayers().push(n),this.markSource=r,this.overlay=o,this.closer=t,this.popup=e,this._save(),this._delete(),this.initialized=!0},_save:function(){var e=this;$("#btnSignSave").on("click",function(){var t=$("#us_infoWnd_title").val(),o=$("#us_infoWnd_remark").val(),r=e.overlay.getPosition(),n=new ol.Feature(new ol.geom.Point(r));n.setId(e.markIdName+e.markIdIdx++),n.set("style",e._createStyle("images/pin_red.png",void 0)),e.markSource.addFeature(n),n.setProperties({title:t,remark:o}),e.delLbl=e._createLabelOverlay(r,t,n.getId()),e._closePopup()})},_createStyle:function(e,t){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.96],src:e,img:t,imgSize:t?[t.width,t.height]:void 0})})},_closePopup:function(){this.overlay.setPosition(void 0),this.closer.blur()},_delete:function(){var e=this;$("#btnSignDelete").on("click",function(){if(e._closePopup(),e.delMark){var t=e.markSource.getFeatureById(e.delMark.getId()),o=map.getOverlayById(e.delMark.getId());null!=t&&e.markSource.removeFeature(t),null!=o&&map.removeOverlay(o),e.delMark=null}})},_createLabelOverlay:function(e,t,o){if(t){var r=document.createElement("div");r.className="labeltip";var n=new ol.Overlay({id:o,element:r,offset:[0,-25],positioning:"bottom-center"});return r.innerHTML=t,n.setPosition(e),map.addOverlay(n),r}},markPlace:function(e){this.initialized||this.init(),$("#us_infoWnd_title").val(""),$("#us_infoWnd_remark").val("");var t=map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});if(t){var o=this.markSource.getFeatureById(t.getId());if(o){var r=o.get("title"),n=o.get("remark");$("#us_infoWnd_title").val(r),$("#us_infoWnd_remark").val(n),this.delMark=o}}var i=e.coordinate;ol.coordinate.toStringHDMS(ol.proj.transform(i,"EPSG:4326","EPSG:4326"));this.overlay.setPosition(i),this.popup.style.display="block"}},w={draw:null,wgs84Sphere:new ol.Sphere(6378137),measureSource:new ol.source.Vector,helpTooltip:null,helpTooltipElement:null,measureTooltip:null,measureTooltipElement:null,sketch:null,init:function(){var e=this;map.getViewport().addEventListener("mouseout",function(){e.helpTooltipElement&&e.helpTooltipElement.classList.add("hidden")});var t=new ol.layer.Vector({source:e.measureSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})});map.addLayer(t)},activeMeasureDis:function(){this.addInteraction(),this.createMeasureTooltip(),this.createHelpTooltip(),this.addMeasureListen(),map.on("pointermove",this.pointerMoveHandler)},deactiveMeasureDis:function(){map.removeInteraction(this.draw),map.un("pointermove",this.pointerMoveHandler),this.measureSource.clear(),$(".tooltip-static").remove()},pointerMoveHandler:function(e){if(!e.dragging){var t="单击开始绘制";w.sketch&&w.sketch.getGeometry()instanceof ol.geom.LineString&&(t="继续点击进行绘制"),w.helpTooltipElement.innerHTML=t,w.helpTooltip.setPosition(e.coordinate),w.helpTooltipElement.classList.remove("hidden")}},addInteraction:function(){var e=this,t=new ol.interaction.Draw({source:e.measureSource,type:"LineString",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgba(255, 204, 51, 0.5)",lineDash:[10,10],width:2}),image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.7)"}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})})});map.addInteraction(t),this.draw=t},createMeasureTooltip:function(){this.measureTooltipElement&&this.measureTooltipElement.parentNode.removeChild(this.measureTooltipElement);var e=document.createElement("div");e.className="tooltip tooltip-measure";var t=new ol.Overlay({element:e,offset:[0,-15],positioning:"bottom-center"});map.addOverlay(t),this.measureTooltip=t,this.measureTooltipElement=e},createHelpTooltip:function(){this.helpTooltipElement&&this.helpTooltipElement.parentNode.removeChild(this.helpTooltipElement);var e=document.createElement("div");e.className="tooltip hidden",helpTooltip=new ol.Overlay({element:e,offset:[15,0],positioning:"center-left"}),map.addOverlay(helpTooltip),this.helpTooltipElement=e,this.helpTooltip=helpTooltip},addMeasureListen:function(){var e,t=this;this.draw.on("drawstart",function(o){t.sketch=o.feature;var r=o.coordinate;e=t.sketch.getGeometry().on("change",function(e){var o,n=e.target;n instanceof ol.geom.LineString&&(o=t.formatLength(n),r=n.getLastCoordinate()),t.measureTooltipElement.innerHTML=o,t.measureTooltip.setPosition(r)})},this),this.draw.on("drawend",function(){t.measureTooltipElement.className="tooltip tooltip-static",t.measureTooltip.setOffset([0,-7]),t.sketch=null,t.measureTooltipElement=null,t.createMeasureTooltip(),ol.Observable.unByKey(e)},this)},formatLength:function(e){var t,o,r=e.getCoordinates();t=0,o=0;for(var n=map.getView().getProjection(),a=0,l=r.length-1;a<l;++a){var s=ol.proj.transform(r[a],n,"EPSG:4326"),c=ol.proj.transform(r[a+1],n,"EPSG:4326");t+=this.wgs84Sphere.haversineDistance(s,c);var u=ol.proj.transform(i.rat_ori(r[a]),n,"EPSG:4326"),d=ol.proj.transform(i.rat_ori(r[a+1]),n,"EPSG:4326");o+=this.wgs84Sphere.haversineDistance(u,d)}t>100?Math.round(t/1e3*100):Math.round(100*t);return o>100?Math.round(o/1e3*100)/100+" km":Math.round(100*o)/100+" m"}};w.init(),map.on("singleclick",function(e){if(map.measureActivated||map.markActivated)r.info("自主标绘或测距已激活，要素暂不响应点击");else{var o=map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});if(o){var n=o.getProperties();r.info(n);var i=t(n);api.FeatureSingleClick(e.coordinate,i)}}}),map.on("dblclick",function(e){if(map.measureActivated||map.markActivated)r.info("自主标绘或测距状态已激活，要素暂不响应点击");else{var o=map.forEachFeatureAtPixel(e.pixel,function(e,t){return e});if(o){var n=t(o.getProperties());api.FeatureDoubleClick(e.coordinate,n)}}});var api={b_isRegistFeatureSigClick:!1,b_isRegistFeatureDblClick:!1,layerManager:{getLayer:function(e){var t=this[e];return void 0===t?(alert(e+"自定义图层不存在"),!1):t}},ExLocate:function(e,t,o){var r=[e,t],n=map.getView();n.setCenter(r),n.setZoom(o)},ExAddIcon:function(e,t,o,r){var n=[e,t],i=new ol.Feature({geometry:new ol.geom.Point(n)});i.setProperties(r);var a=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:o})});i.setStyle(a),u.getSource().addFeature(i)},ExAddLabel:function(e,t,o){var r=[e,t],n=document.createElement("div");n.className="labeltip";var i=new ol.Overlay({element:n,offset:[0,-25]});return n.innerHTML=labelTxt,i.setPosition(r),map.addOverlay(i),n},ActiveMark:function(){map.markActivated=!0,this.DeactiveMeasureDis(),map.on("singleclick",this.common.markPlace)},DeactiveMark:function(){map.markActivated=!1,map.un("singleclick",this.common.markPlace)},ActiveMeasureDis:function(){map.measureActivated=!0,this.DeactiveMark(),w.activeMeasureDis()},DeactiveMeasureDis:function(){map.measureActivated=!1,w.deactiveMeasureDis()},AddLayer:function(e){if(null!=this.layerManager[e])return alert("图层名称不能重复"),!1;var t=new ol.layer.Vector({style:function(e){return e.get("style")},source:new ol.source.Vector});return map.getLayers().push(t),this.layerManager[e]=t,!0},AddImageOnLayer:function(e,t,o){var r=new ol.Feature(new ol.geom.Point([t,o]));r.set("style",this.common.createDefaultIconStyle());var n=this.layerManager.getLayer(e);n&&n.getSource().addFeature(r)},HideLayer:function(e){var t=this.layerManager.getLayer(e);t&&t.setVisible(!1)},ShowLayer:function(e){var t=this.layerManager.getLayer(e);t&&t.setVisible(!0)},RemoveLayer:function(e){var t=this.layerManager.getLayer(e);t&&(map.removeLayer(t),this.layerManager[e]=void 0)},AddLabelOnLayer:function(e,t,o,r){var n=document.createElement("div");n.className="labeltip "+e;var i=new ol.Overlay({element:n,offset:[0,-25]});return n.innerHTML=r,i.setPosition([t,o]),map.addOverlay(i),n},HideLabelOnLayer:function(e){$("."+e).addClass("hideElement")},ShowLabelOnLayer:function(e){$("."+e).removeClass("hideElement")},WfsQuery:function(e){y.clear();var t=this.common.createGetFeatureRequest(e),o=(new XMLSerializer).serializeToString(t);$.ajax({type:"POST",url:n.map.geoserver+"/wfs",data:o,contentType:"application/json",datType:"json",success:function(e){var t=new ol.format.GeoJSON({defaultDataProjection:"EPSG:3857",featureProjection:"EPSG:4326"}).readFeatures(e);y.addFeatures(t),map.getView().fit(y.getExtent())},error:function(e){alert(e)}})},RegistFeaturSingleClick:function(){this.b_isRegistFeatureSigClick=!0},FeatureSingleClick:function(e,t){if(this.b_isRegistFeatureSigClick){r.debug(t);var o=this.common.createFeatureInfo(t);h.show(e,o)}else alert("请先注册要素点击接口")},RegistFeatureDoubleClick:function(){this.b_isRegistFeatureDblClick=!0},FeatureDoubleClick:function(e,t){if(this.b_isRegistFeatureDblClick){var o=this.common.createFeatureInfo(t);h.show(e,o)}else alert("请先注册要素点击接口")},common:{createFeatureInfo:function(e){var t="";return t+='<p><img  src="'+("./xianlianhuqu/"+e.QKID.substr(3,3)+"/"+("DSCN"+i.zeroPad(e.PICTURE,4)+".JPG"))+'" ></img></p><table border="1" cellpadding="0" cellspacing="0"><tr><td>JID</td><td>'+e.JID+"</td></tr><tr><td>Name</td><td>"+e.NAME+"</td></tr><tr><td>Address</td><td>"+e.ADDRESS+"</td></tr></table>"},createGetFeatureRequest:function(e){return(new ol.format.WFS).writeGetFeature({srsName:"EPSG:3857",featurePrefix:n.map.featurePrefix,featureTypes:n.map.featureTypes,outputFormat:"application/json",filter:ol.format.filter.or(ol.format.filter.like("NAME",e),ol.format.filter.like("ADDRESS",e))})},createDefaultIconStyle:function(){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.96],src:"images/pin_red.png"})})},markPlace:function(e){g.markPlace(e)}}};